name: test-action

on:
  push:

jobs:
  test-action:
    permissions:
      id-token: write
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        module:
          - sbom
    steps:
    - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11

    - uses: dorny/paths-filter@1441771bbfdd59dcd748680ee64ebd8faab1a242
      id: changes
      with:
        filters: |
          src:
            - "${{ matrix.module }}/**"
            - ".github/workflows/test-action.yml"

    - name: Setup Go
      if: steps.changes.outputs.src == 'true'
      uses: actions/setup-go@6c1fd22b67f7a7c42ad9a45c0f4197434035e429
      with:
        go-version: 1.21

    - name: Setup act
      if: steps.changes.outputs.src == 'true'
      run: go install github.com/nektos/act@master
      shell: bash

    - name: Run test
      if: steps.changes.outputs.src == 'true'
      shell: bash
      run: |
        act \
          -W __tests__ \
          -j ${{ matrix.module }} \
          --bind \
          -s GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }} \
          -s GHCR_PASSWORD=${{ secrets.GHCR_PASSWORD }} \
          -P ubuntu-latest=ghcr.io/catthehacker/ubuntu:act-latest
