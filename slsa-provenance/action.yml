name: 'Generate SLSA Provenance'
description: 'Generate SLSA Provenance from artifacts'
inputs:
  action-sha:
    description: "SHA of this action used (needed for extra material)."
    required: true
  image:
    description: "Full image path to generate provenance for."
    required: true
  artifact-path:
    description: "Path of artifacts"
    required: true
  output:
    description: "Output file"
    required: true
    default: "provenance.json"
  sign:
    description: "Sign provenance with cosign"
    required: false
    default: 'false'
  attest:
    description: "Attest the image with the generated provenance"
    required: false
    default: 'false'
  cosign-password:
    description: "Cosign password"
    required: false
runs:
  using: "composite"
  steps:
    - name: Create additional material
      shell: bash
      run: |
        echo "[{\"uri\": \"git+https://github.com/ckotzbauer/actions-toolkit\",\"digest\": {\"sha1\": \"${{ inputs.action-sha }}\"}}]" > material.json

    - name: Generate provenance
      uses: philips-labs/slsa-provenance-action@8f3f6a835ccfa2c0d5fb1d6dce15691a86575659
      with:
        arguments: -d --artifact-path ${{ inputs.artifact-path }} --extra-materials material.json --output-path ${{ inputs.output }}

    - name: Sign Provenance
      if: ${{ inputs.sign == 'true' }}
      run: cosign sign-blob --key cosign.key --output-signature ${{ inputs.output }}.sig ${{ inputs.output }}
      shell: sh
      env:
        COSIGN_PASSWORD: ${{ inputs.cosign-password }}
        COSIGN_EXPERIMENTAL: "1"

    - name: Attest image with Provenance
      if: ${{ inputs.attest == 'true' }}
      run: cosign attest --key cosign.key -f --predicate ${{ inputs.output }} ${{ inputs.image }}
      shell: sh
      env:
        COSIGN_PASSWORD: ${{ inputs.cosign-password }}
        COSIGN_EXPERIMENTAL: "1"
